# Usage Guide

## The easy way

The easist way to use these packages is by creating a project with `Briefcase
<https://github.com/beeware/briefcase>`__. Briefcase will download pre-compiled
versions of these support packages, and add them to an Xcode project (or
pre-build stub application, in the case of macOS).

## The manual way

**NOTE** Briefcase usage is the officially supported approach for using this
support package. If you are experiencing diffculties, one approach for debugging
is to generate a "Hello World" project with Briefcase, and compare the project that
Briefcase has generated with your own project.

The Python support package *can* be manually added to any Xcode project;
however, you'll need to perform some steps manually (essentially reproducing
what Briefcase is doing). The steps required are documented in the CPython usage
guides:

* [macOS](https://docs.python.org/3/using/mac.html)
* [iOS](https://docs.python.org/3/using/ios.html#adding-python-to-an-ios-project)

For tvOS and watchOS, you should be able to broadly follow the instructions in
the iOS guide.

## Accessing the Python runtime

There are 3 ways to access the Python runtime in your project code.

### Use C/Objective-C/C++ with Embedded C API

You can use the [Python Embedded C
API](https://docs.python.org/3/extending/embedding.html) to instantiate a Python
interpreter. This is the approach taken by Briefcase; you may find the bootstrap
mainline code generated by Briefcase a helpful guide to what is needed to start
an interpreter and run Python code.

### Use Swift with Embedded C API
If you want to use Python framework in Swift, you should do some additional setups.

1. Edit all `Python.xcframework/*/Python.framework`
    1. Make a `Modules/module.modulemap` file
        ```shell
        cd Python.xcframework/macos-arm64_x86_64/Python.framework
        mkdir Modules
        touch Modules/module.modulemap
        ```
         `macos-arm64_x86_64` in the cd command, should be changed to your target platform

    2. Fill `Modules/module.modulemap` with the content:
        ```
        framework module Python {
            umbrella header "Python.h"
            export *
            link "Python"
        }
        ```
        
    3. Edit `Headers/cpython/pyatomic.h`,  in the file:
        - replace ``cpython/pyatomic_gcc.h`` with ``pyatomic_gcc.h``
        - replace ``cpython/pyatomic_std.h`` with ``pyatomic_std.h``
        - replace ``cpython/pyatomic_msc.h`` with ``pyatomic_msc.h``

2. In your Swift code, set environment variables before init Python (iOS only, macOS do not need this step)

```swift
import Python
func setEnvs() {
    #if not os(macOS)
    guard let pythonHome = Bundle.main.path(forResource: "python", ofType: nil) else { return }
    setenv("PYTHONHOME", pythonHome, 1)
    
    /*
         The PYTHONPATH for the interpreter includes:
         the python/lib/python3.X subfolder of your app’s bundle,
         the python/lib/python3.X/lib-dynload subfolder of your app’s bundle, and
         the app subfolder of your app’s bundle
    */
    guard let pythonPath = Bundle.main.path(forResource: "python/lib/python3.13", ofType: nil) else { return }
    guard let libDynLoad = Bundle.main.path(forResource: "python/lib/python3.13/lib-dynload", ofType: nil) else { return }
    let appPath = Bundle.main.path(forResource: "app", ofType: nil)
    setenv("PYTHONPATH", [pythonPath, libDynLoad, appPath].compactMap { $0 }.joined(separator: ":"), 1)
    #endif
}
```

4. In your Swift code, initialize the Python runtime. This should generally be
   done as early as possible in the application's lifecycle, but definitely
   needs to be done before you invoke Python code:
```Swift
import Foundation
import Python

setEnvs()
Py_Initialize()
let version = String(cString: Py_GetVersion())
print(version)
// we now have a Python interpreter ready to be used
```

After init Python, you could use Embed C API in Swift directly.

To integrate 3rd party python code and dependencies, you will need to make sure
`PYTHONPATH` contains their paths; once this has been done, you can run
`Python.import("<lib name>")`. to import that module from inside swift.


### Use Swift with `PythonKit`

Instead of using Embed C API, an alternate approach is to use
[PythonKit](https://github.com/pvieito/PythonKit). 

PythonKit is a package that
provides Swift friendly API to running Python code.

To use PythonKit in your project:

1. Do all steps of "Use Swift with Embedded C API" above
2. Add PythonKit to your project using the Swift Package manager. See the
   PythonKit documentation for details.

3. Invoke Python code in your app. For example:
```swift
import Foundation
import Python
import PythonKit

setEnvs()
Py_Initialize()
let sys = Python.import("sys")
print("Python Version: \(sys.version_info.major).\(sys.version_info.minor)")
print("Python Encoding: \(sys.getdefaultencoding().upper())")
print("Python Path: \(sys.path)")

_ = Python.import("math") // verifies `lib-dynload` is found and signed successfully
```
